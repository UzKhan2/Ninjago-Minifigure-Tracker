<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Zane Collection Tracker</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon" />

    <style>
      /* ================= BASE ================= */

      body {
        font-family: Arial, sans-serif;
        background: #f5f5f5;
        padding: 20px;
        transition: 0.3s;
      }

      body.dark {
        background: #121212;
        color: white;
      }

      h1 {
        text-align: center;
      }

      /* ================= TOGGLE ================= */

      .toggle {
        text-align: center;
        margin-bottom: 15px;
      }

      .toggle button {
        padding: 8px 14px;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        font-weight: bold;
        margin: 0 4px;
      }

      .active-btn {
        background: #4caf50;
        color: white;
      }

      /* ================= CONTROLS ================= */

      .controls {
        text-align: center;
        margin-bottom: 10px;
      }

      .controls input,
      .controls select {
        padding: 6px;
        border-radius: 6px;
        border: 1px solid #ccc;
        margin: 4px;
      }

      body.dark input,
      body.dark select {
        background: #333;
        color: white;
        border: 1px solid #555;
      }

      /* ================= SETTINGS MODAL ================= */

      .modal-overlay {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      .modal-overlay.show {
        display: block;
        opacity: 1;
      }

      .settings-panel {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) scale(0.8);
        max-width: 400px;
        width: 90%;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.25);
        padding: 20px;
        z-index: 1001;
        text-align: center;
        opacity: 0;
        transition:
          opacity 0.3s ease,
          transform 0.3s ease;
      }

      .settings-panel.show {
        display: block;
        opacity: 1;
        transform: translate(-50%, -50%) scale(1);
      }

      body.dark .settings-panel {
        background: #2c2c2c;
        color: white;
      }

      .settings-panel h3 {
        margin-top: 0;
      }

      .settings-panel button,
      .settings-panel input[type="file"] {
        margin: 8px 0;
        padding: 8px 12px;
        border-radius: 8px;
        border: none;
        cursor: pointer;
      }

      .settings-panel .close-btn {
        position: absolute;
        top: 10px;
        right: 12px;
        background: transparent;
        border: none;
        font-size: 1.3em;
        cursor: pointer;
        color: inherit;
      }

      /* ================= PROGRESS BAR ================= */

      .progress-container {
        width: 90%;
        height: 16px;
        background: #ddd;
        border-radius: 8px;
        margin: 15px auto;
        overflow: hidden;
      }

      .progress-bar {
        height: 100%;
        background: #4caf50;
        width: 0%;
        transition: 0.3s;
      }

      /* ================= GRID ================= */

      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, 150px);
        gap: 12px;
        justify-content: center;
        margin-top: 20px;
      }

      /* ================= RARITY GLOW VARIABLES ================= */

      :root {
        --glow-common: 0 0 8px #cccccc70;
        --glow-uncommon: 0 0 8px #4caf5070;
        --glow-rare: 0 0 10px #2196f380;
        --glow-epic: 0 0 12px #b000b080;
        --glow-legendary: 0 0 8px #ff9800aa;
      }

      body.dark {
        --glow-common: 0 0 8px #cccccc70;
        --glow-uncommon: 0 0 14px #4caf50cc;
        --glow-rare: 0 0 18px #2196f3ff;
        --glow-epic: 0 0 20px #b000b0ff;
        --glow-legendary: 0 0 22px #ff9800ff;
      }

      /* ================= CARD ================= */

      .card {
        height: 200px;
        background: white;
        border-radius: 12px;
        padding: 12px;
        text-align: center;
        cursor: pointer;
        box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
        transition:
          transform 0.2s,
          box-shadow 0.3s,
          border-color 0.3s;
        position: relative;
        overflow: hidden;
        border: 3px solid transparent;
      }

      body.dark .card {
        background: #1e1e1e;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.6);
      }

      .card:hover {
        transform: scale(1.05);
      }

      /* ================= OWNED GLOW ================= */

      .card.owned {
        background: #c8f7c5 !important;
      }

      body.dark .card.owned {
        background: #2e5f2e !important;
      }

      /* ================= RARITY GLOW ================= */

      .rarity-common {
        border-color: #cccccc;
        box-shadow: var(--glow-common);
      }

      .rarity-uncommon {
        border-color: #4caf50;
        box-shadow: var(--glow-uncommon);
      }

      .rarity-rare {
        border-color: #2196f3;
        box-shadow: var(--glow-rare);
      }

      .rarity-epic {
        border-color: #70085a;
        box-shadow: var(--glow-epic);
      }

      body.dark .rarity-common {
        border-color: #cccccc;
        box-shadow: var(--glow-common);
      }

      body.dark .rarity-uncommon {
        border-color: #4caf50;
        box-shadow: var(--glow-uncommon);
      }

      body.dark .rarity-rare {
        border-color: #2196f3;
        box-shadow: var(--glow-rare);
      }

      body.dark .rarity-epic {
        border-color: #70085a;
        box-shadow: var(--glow-epic);
      }

      .rarity-legendary {
        border-color: #ff9800;
        animation: legendaryPulse 2s infinite;
      }

      @keyframes legendaryPulse {
        0% {
          box-shadow: 0 0 8px #ff9800aa;
        }
        50% {
          box-shadow: 0 0 20px #ff9800ff;
        }
        100% {
          box-shadow: 0 0 8px #ff9800aa;
        }
      }

      /* ================= BADGE ================= */

      .rarity-badge {
        position: absolute;
        top: 6px;
        right: 6px;
        padding: 3px 6px;
        font-size: 0.7em;
        font-weight: bold;
        color: white;
        border-radius: 6px;
        opacity: 0.9;
      }

      .badge-common {
        background: #cccccc;
      }
      .badge-uncommon {
        background: #4caf50;
      }
      .badge-rare {
        background: #2196f3;
      }
      .badge-epic {
        background: #70085a;
      }
      .badge-legendary {
        background: #ff9800;
      }

      /* ================= CARD FRONT/BACK ================= */

      .front,
      .back {
        position: absolute;
        inset: 0;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        padding: 10px;
        text-align: center;
      }

      .back {
        display: none;
        font-size: 0.85em;
        gap: 4px;
      }

      .card:hover .front {
        display: none;
      }
      .card:hover .back {
        display: flex;
      }

      .minifig-img {
        width: 100px;
      }

      .figure-name {
        font-weight: bold;
        font-size: 0.9em;
        overflow: hidden;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
      }

      .links {
        display: flex;
        flex-direction: column;
        gap: 4px;
        margin-top: 6px;
      }

      .links a {
        color: #007bff;
        text-decoration: none;
        font-size: 0.9em;
      }

      .links a:hover {
        text-decoration: underline;
      }

      .disabled {
        color: gray;
      }

      .count {
        text-align: center;
        font-weight: bold;
        margin-top: 10px;
      }
    </style>
  </head>

  <body>
    <h1>Zane Collection Tracker</h1>

    <div class="toggle">
      <button id="btnFigures" onclick="loadData('figures', this)">
        Minifigs
      </button>
      <button id="btnBricks" onclick="loadData('bricks', this)">Bricks</button>
      <button onclick="toggleSettings()">⚙ Settings</button>
    </div>

    <div class="controls">
      <input
        type="text"
        id="search"
        placeholder="Search..."
        oninput="filterAndRender()"
      />

      <select id="sort" onchange="filterAndRender()">
        <option value="year">Sort by Year</option>
        <option value="name">Sort by Name</option>
        <option value="rarity">Sort by Rarity</option>
      </select>

      <select id="categoryFilter" onchange="filterAndRender()">
        <option value="">All Categories</option>
      </select>

      <select id="sizeSelect" onchange="filterAndRender()">
        <option value="small">Small</option>
        <option value="medium" selected>Medium</option>
        <option value="large">Large</option>
      </select>
    </div>

    <!-- Modal Overlay -->
    <div
      class="modal-overlay"
      id="modalOverlay"
      onclick="closeSettings()"
    ></div>

    <!-- Settings Panel Modal -->
    <div class="settings-panel" id="settingsPanel">
      <button class="close-btn" onclick="closeSettings()">×</button>
      <h3>Settings</h3>
      <button onclick="toggleDarkMode()">Dark / Light Mode</button><br />
      <button onclick="markAllOwned()">Mark All Owned</button><br />
      <button onclick="resetAll()">Reset All</button><br />
      <button onclick="exportCollection()">Export JSON</button><br />
      <input type="file" onchange="importCollection(event)" />
    </div>

    <div class="progress-container">
      <div class="progress-bar" id="progressBar"></div>
    </div>

    <div class="count" id="count"></div>
    <div class="grid" id="grid"></div>

    <script>
      /* FULL JS LOGIC (with modal animation) */

      let items = [];
      let currentType = "figures";
      let owned = JSON.parse(localStorage.getItem("ownedItems") || "{}");

      const grid = document.getElementById("grid");
      const countEl = document.getElementById("count");
      const progressBar = document.getElementById("progressBar");

      function save() {
        localStorage.setItem("ownedItems", JSON.stringify(owned));
      }

      function getRarityClass(rarity) {
        if (!rarity) return {};
        const r = rarity.toLowerCase();
        if (r === "common")
          return { border: "rarity-common", badge: "badge-common" };
        if (r === "uncommon")
          return { border: "rarity-uncommon", badge: "badge-uncommon" };
        if (r === "rare") return { border: "rarity-rare", badge: "badge-rare" };
        if (r === "epic") return { border: "rarity-epic", badge: "badge-epic" };
        if (r.includes("legendary"))
          return { border: "rarity-legendary", badge: "badge-legendary" };
        return {};
      }

      function updateCount(filtered) {
        const total = filtered.length;
        const have = filtered.filter((i) => owned[i.FigureID]).length;
        countEl.textContent = `${have} / ${total} collected`;
        progressBar.style.width = total ? (have / total) * 100 + "%" : "0%";
      }

      function filterAndRender() {
        let filtered = [...items];
        const search = document.getElementById("search").value.toLowerCase();
        if (search)
          filtered = filtered.filter((i) =>
            i.FigureName.toLowerCase().includes(search),
          );
        const category = document.getElementById("categoryFilter").value;
        if (category)
          filtered = filtered.filter((i) => i.Category === category);

        const sort = document.getElementById("sort").value;
        if (sort === "name")
          filtered.sort((a, b) => a.FigureName.localeCompare(b.FigureName));
        if (sort === "year")
          filtered.sort((a, b) => (a.Year || 0) - (b.Year || 0));
        if (sort === "rarity")
          filtered.sort((a, b) =>
            (a.Rarity || "").localeCompare(b.Rarity || ""),
          );

        render(filtered);
      }

      function render(filtered) {
        grid.innerHTML = "";
        filtered.forEach((item) => {
          const card = document.createElement("div");
          card.className = "card";
          card.tabIndex = 0;
          const rarity = getRarityClass(item.Rarity);
          if (rarity.border) card.classList.add(rarity.border);
          if (owned[item.FigureID]) card.classList.add("owned");
          const size = document.getElementById("sizeSelect").value;
          const imgSize =
            size === "small" ? "70px" : size === "large" ? "130px" : "100px";
          const isBrick = currentType === "bricks";
          const bricklink = item.FigureID
            ? isBrick
              ? `https://www.bricklink.com/v2/catalog/catalogitem.page?P=${item.FigureID}`
              : `https://www.bricklink.com/v2/catalog/catalogitem.page?M=${item.FigureID}`
            : null;
          const bricksetLink = isBrick
            ? item.BricksetID
              ? `https://brickset.com/parts/${item.BricksetID}`
              : null
            : item.FigureID
              ? `https://brickset.com/minifigs/${item.FigureID}`
              : null;

          card.innerHTML = `
            <div class="front">
              <img src="images/${currentType}/${item.FigureID?.toLowerCase()}.png" onerror="this.src='images/placeholder.png'" style="width:${imgSize}" class="minifig-img">
              <div class="figure-name">${item.FigureName}</div>
            </div>
            <div class="back">
              <div class="figure-name">${item.FigureName}</div>
              <div>${item.Series || ""}</div>
              <div>${item.Category || ""}</div>
              <div>${item.Year || ""}</div>
              <div>${item.Sets || ""} Sets</div>
              <div>${item.Rarity || ""}</div>
              <div class="links">
                ${bricklink ? `<a href="${bricklink}" target="_blank">BrickLink</a>` : `<span class="disabled">No BrickLink</span>`}
                ${bricksetLink ? `<a href="${bricksetLink}" target="_blank">BrickSet</a>` : `<span class="disabled">No BrickSet</span>`}
              </div>
            </div>
            ${item.Rarity ? `<div class="rarity-badge ${rarity.badge}">${item.Rarity}</div>` : ""}
          `;
          card
            .querySelectorAll("a")
            .forEach((a) =>
              a.addEventListener("click", (e) => e.stopPropagation()),
            );
          card.onclick = () => {
            owned[item.FigureID] = !owned[item.FigureID];
            save();
            filterAndRender();
          };
          grid.appendChild(card);
        });
        updateCount(filtered);
      }

      function loadData(type, btn) {
        currentType = type;
        fetch(`data/${type}.json`)
          .then((r) => r.json())
          .then((data) => {
            items = data;
            const categoryFilter = document.getElementById("categoryFilter");
            categoryFilter.innerHTML =
              '<option value="">All Categories</option>';
            [...new Set(data.map((i) => i.Category).filter(Boolean))]
              .sort()
              .forEach(
                (c) =>
                  (categoryFilter.innerHTML += `<option value="${c}">${c}</option>`),
              );
            filterAndRender();
            document
              .querySelectorAll(".toggle button")
              .forEach((b) => b.classList.remove("active-btn"));
            btn.classList.add("active-btn");
          });
      }

      function toggleSettings() {
        document.getElementById("settingsPanel").classList.toggle("show");
        document.getElementById("modalOverlay").classList.toggle("show");
      }

      function closeSettings() {
        document.getElementById("settingsPanel").classList.remove("show");
        document.getElementById("modalOverlay").classList.remove("show");
      }

      function toggleDarkMode() {
        document.body.classList.toggle("dark");
      }

      function markAllOwned() {
        Promise.all([
          fetch("data/figures.json").then((r) => r.json()),
          fetch("data/bricks.json").then((r) => r.json()),
        ]).then(([figures, bricks]) => {
          [...figures, ...bricks].forEach((item) => {
            if (item.FigureID) {
              owned[item.FigureID] = true;
            }
          });

          save();
          filterAndRender();
        });
      }

      function resetAll() {
        owned = {};
        save();
        filterAndRender();
      }

      function exportCollection() {
        const blob = new Blob([JSON.stringify(owned, null, 2)], {
          type: "application/json",
        });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "collection.json";
        a.click();
      }

      function importCollection(e) {
        const reader = new FileReader();
        reader.onload = () => {
          owned = JSON.parse(reader.result);
          save();
          filterAndRender();
        };
        reader.readAsText(e.target.files[0]);
      }

      document.addEventListener("keydown", (e) => {
        const cards = [...grid.querySelectorAll(".card")];
        if (!cards.length) return;
        let idx = cards.indexOf(document.activeElement);
        if (idx === -1) idx = 0;
        if (e.key === "ArrowRight") idx = (idx + 1) % cards.length;
        if (e.key === "ArrowLeft")
          idx = (idx - 1 + cards.length) % cards.length;
        if (e.key === "ArrowDown") idx = (idx + 5) % cards.length;
        if (e.key === "ArrowUp") idx = (idx - 5 + cards.length) % cards.length;
        if (["ArrowRight", "ArrowLeft", "ArrowDown", "ArrowUp"].includes(e.key))
          cards[idx].focus();
        if (e.key === "Enter" || e.key === " ") cards[idx].click();
      });

      loadData("figures", document.getElementById("btnFigures"));
    </script>
  </body>
</html>
